{% extends 'base.html' %}

{% block content %}

<h2>Project Kanban Board</h2>

<input type="text" id="taskTitle" placeholder="New Task">
<button onclick="addTask()">Add Task</button>

<div style="display:flex; gap:20px; margin-top:20px;">

    <!-- TODO -->
    <div style="flex:1; background:white; padding:10px;">
        <h3>Upcoming</h3>
        <div id="todo"></div>
    </div>

    <!-- IN PROGRESS -->
    <div style="flex:1; background:white; padding:10px;">
        <h3>In Progress</h3>
        <div id="progress"></div>
    </div>

    <!-- DONE -->
    <div style="flex:1; background:white; padding:10px;">
        <h3>Completed</h3>
        <div id="done"></div>
    </div>

</div>

<script>

function loadTasks(){
    fetch('/projects/tasks/')
    .then(res => res.json())
    .then(data => {

        document.getElementById('todo').innerHTML = "";
        document.getElementById('progress').innerHTML = "";
        document.getElementById('done').innerHTML = "";

        data.tasks.forEach(t => {
            let html = `
                <div style="background:#e2e8f0; margin:5px; padding:10px;">
                    ${t.title}<br>
                    <button onclick="move(${t.id}, 'todo')">Todo</button>
                    <button onclick="move(${t.id}, 'progress')">Progress</button>
                    <button onclick="move(${t.id}, 'done')">Done</button>
                </div>
            `;

            document.getElementById(t.status).innerHTML += html;
        });
    });
}

function addTask(){
    fetch('/projects/create-task/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRF()
        },
        body: JSON.stringify({
            title: document.getElementById('taskTitle').value,
            project_id: 1   // temp (later dynamic)
        })
    }).then(() => loadTasks());
}

function move(id, status){
    fetch('/projects/update-task/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRF()
        },
        body: JSON.stringify({
            id: id,
            status: status
        })
    }).then(() => loadTasks());
}

function getCSRF(){
    return document.cookie.split('; ')
        .find(row => row.startsWith('csrftoken'))
        ?.split('=')[1];
}

loadTasks();

</script>

{% endblock %}